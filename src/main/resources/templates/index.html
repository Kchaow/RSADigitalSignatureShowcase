<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@5.0.0/bundles/stomp.umd.js"></script>
    <script>
        window.onload = function ()
        {
            const client = new StompJs.Client({
            brokerURL: 'ws://localhost:8080/ws',
            debug: function (str) {
                console.log(str);
            },
            reconnectDelay: 15000,
            heartbeatIncoming: 4000,
            heartbeatOutgoing: 4000,
            });

            client.onConnect = function (frame) {
                // Do something, all subscribes must be done is this callback
                // This is needed because this will be executed after a (re)connect
                let cookies = document.cookie.split(';');
                let sessionId;
                for (let i = 0; i < cookies.length; i++)
                {
                    let cookie = cookies[i].split('=');
                    if (cookie[0] == 'JSESSIONID')
                    {
                        sessionId = cookie[1];
                        break;
                    }
                }

                const subscription = client.subscribe(`/topic/connections/${sessionId}`, connectionsCallback);
                let input = document.querySelector('.idInput');
                let button = document.querySelector('.myButton');
                button.addEventListener("click", () => {
                    console.log('send');
                    let connectionStatus = {
                        "userId": input.value,
                        "status": "connectionRequest"
                    }
                    client.publish({
                    destination: '/app/requestConnection',
                    body: JSON.stringify(connectionStatus),
                });
        });
        console.log('Hello my dear frient')

            };

            client.onStompError = function (frame) {
                // Will be invoked in case of error encountered at Broker
                // Bad login/passcode typically will cause an error
                // Complaint brokers will set `message` header with a brief message. Body may contain details.
                // Compliant brokers will terminate the connection after any error
                console.log('Broker reported error: ' + frame.headers['message']);
                console.log('Additional details: ' + frame.body);
            };

            const connectionsCallback = function (message) {
                // called when the client receives a STOMP message from the server
                console.log('AAAAAAAA');
                if (message.body) {
                    console.log('got message with body ' + message.body);
                } else {
                    console.log('got empty message');
                }
            };

            client.activate();
    }
    </script>
</head>
<body>
    <h3 th:text="${sessionId}"></h3>
    <input type="text" class="idInput"/>
    <button class="myButton">Button</button>
</body>
</html>